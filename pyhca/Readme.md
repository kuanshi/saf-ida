# Hazard Consistent Adjustment

The key idea of the hazard consistent adjustment is first to learn and generalize performance metric (PM) models conditional on the ground motion intensity measures and then to compute them per site-specific intensity measure targets. To estimate PM models as functions of ground motion intensity measures, i.e., P(PM|IM), the SAF-IDA uses the IM capacity method ([Baker and Cornell, 2005](https://onlinelibrary.wiley.com/doi/abs/10.1002/eqe.474)) that is particularly suitable for estimating non-parametric performance metrics (e.g., collapse and damage state indicators). The figure below gives one example for estimating the PM model of the maixmum story drift ratio in a 12-story frame.

<p align="center">
 <img width="100%" height="100%" src="https://github.com/kuanshi/shaf-ida/blob/master/doc/image/HCA_SurrogateModel.png">
</p>

At a given site, one could conduct seismic hazard analysis and develope the corresponding IM target conditioning on Sa, i.e., P(IM|Sa). The left plot in the figure below gives two examples of the joint distribution of SaRatio and Ds<sub>5-75</sub> conditioning on Sa. Given the P(PM|IM) and P(IM|Sa), one could easily compute the probabilistic distribution P(PM|Sa) by integrating the two components over the IM domain. The right two plots in the figure below are the examples for resulting site-specific probabilistic distributions of maximum SDR and collapse. 

<p align="center">
 <img width="100%" height="100%" src="https://github.com/kuanshi/shaf-ida/blob/master/doc/image/HCA_SiteIntegral.png">
</p>

One special consideration that the SAF-IDA has is the optimal (most effective and sufficinet) intensity measures are different for different PMs and for different PM levels. The figure below tries to illustrate this idea. The left plot shows the R<super>2</super> of SDR<sub>max</sub>=0.008 models with different SaRatio(T<sub>a</sub>,T<sub>1</sub>,T<sub>b</sub>) where the most effective period range is 0.95T<sub>1</sub> to 1.8T<sub>1</sub>. The middle plot shows the result for SDR<sub>max</sub>=0.027 where the optimal period range is 0.2T<sub>1</sub> to 2.75T<sub>1</sub>. The right plots summarize the optimal period ranges for different SDR<sub>max</sub> levels. As SDR<sub>max</sub> increases, the frame experiences more nonlinearities (period shifting), and thus the optimal peirod range expands. Built on this fact, the SAF-IDA looks for the optimal combination of intensity measures for indivial models and carries them through the site-specific intensity target calculation.

<p align="center">
 <img width="100%" height="100%" src="https://github.com/kuanshi/shaf-ida/blob/master/doc/image/HCA_OptimalIM.png">
</p>

Another interesting phenoneon that the SAF-IDA takes into account is the local nonlinearity of collapse surrogate models. If regressing the collapse Sa with respect to the SaRatio and Ds<sub>5-75</sub> over all IDA data, one would get one set of coefficient for the global hyperplane. If regressing the collapse Sa for separate bins of SaRatio values, one would get different coefficients for individual bins. The left plot in the figure below shows resulting coefficients of Ds<sub>5-75</sub> given different SaRatio values (the blue curve) against the global linear model (the red dashed line). This is a perfect example of interaction between the two intensity measures to influence the structural collapse intensity: because the coupled mechanism between the two intensity measures, the duration impact is more significant when the spectral shape is already damaging. This idea is visualized in the right plot where the local linear regression was structured and implemented to find the median surface of the collapse surrogate model (green).

<p align="center">
 <img width="90%" height="90%" src="https://github.com/kuanshi/shaf-ida/blob/master/doc/image/HCA_LocalLinearModel.png">
</p>

In constrast to the global linear model, this application significantly improves the SAF-IDA's accuracy for the adjusted collapse fragilities:

<p align="center">
 <img width="90%" height="90%" src="https://github.com/kuanshi/shaf-ida/blob/master/doc/image/HCA_compMSA.png">
</p>

The [example.py](https://github.com/kuanshi/shaf-ida/blob/master/pyhca/example.py) gives a detailed demo of using the pyhca package. The three data files needed are (1) the nested ground motion characteristics (e.g., [NGMS_T1.71G7x7.json](https://github.com/kuanshi/shaf-ida/blob/master/pyhca/data/NGMS_T1.71G7x7.json) which can be directly generated by pyngms), (2) the formatted structural analysis data from IDA (e.g., I[DAData.json](https://github.com/kuanshi/shaf-ida/blob/master/pyhca/data/IDAData.json)), and (3) the site-specific intensity measure target (e.g., which can be created by using the [pygmm](https://pypi.org/project/pygmm/) package and [USGS National Seismic Hazard Mapping Project (NSHMP) Code](https://github.com/usgs/nshmp-haz)).
